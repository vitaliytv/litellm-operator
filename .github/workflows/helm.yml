name: Helm Chart

# This workflow handles:
# 1. Linting and testing Helm charts on PRs
# 2. Publishing Helm charts to OCI registry on releases
# 3. Only publishes when a release is created (not on PR merges)

on:
  push:
    branches:
      - main
    paths:
      - "helm/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  lint-helm-chart:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.12.0

    - name: Lint Helm chart
      run: |
        helm lint helm/
        helm template litellm-operator helm/ > /dev/null

  test-helm-chart:
    runs-on: ubuntu-latest
    needs: lint-helm-chart
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.12.0

    - name: Validate Helm chart
      run: |
        # Render templates to validate they work correctly
        helm template litellm-operator helm/ --dry-run
        # Test with different values to ensure templates are robust
        helm template litellm-operator helm/ --dry-run --set replicaCount=3
        helm template litellm-operator helm/ --dry-run --set image.tag=latest

  publish-helm-chart:
    runs-on: ubuntu-latest
    needs: [lint-helm-chart, test-helm-chart]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.12.0

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version from Chart.yaml
      id: version
      run: |
        VERSION=$(grep '^version:' helm/Chart.yaml | awk '{print $2}')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing chart version $VERSION to GitHub Packages"

    - name: Chart | Push
      uses: appany/helm-oci-chart-releaser@v0.5.0
      with:
        name: litellm-operator
        repository: bbdsoftware/charts/
        tag: ${{ steps.version.outputs.version }}
        path: helm/
        registry: ghcr.io
        registry_username: ${{ github.actor }}
        registry_password: ${{ secrets.GITHUB_TOKEN }}
        update_dependencies: 'false' 