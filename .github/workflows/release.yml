name: Release and Publish

on:
  push:
    tags:
      - "v*"
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "README.md"
      - "CHANGELOG.md"
      - "CONTRIBUTING.md"
      - "SECURITY.md"
      - "LICENSE"

permissions:
  contents: write
  packages: write
  id-token: write
  pull-requests: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Run tests
      run: make test

    - name: Run linting
      uses: golangci/golangci-lint-action@v8.0.0
      with:
        version: latest

  build-and-release:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate semver tag
      id: semver
      uses: matt-usurp/validate-semver@v2
      with:
        version: ${{ github.ref }}

    - name: Display version info
      run: |
        echo "âœ… Valid semver tag: ${{ steps.semver.outputs.version }}"
        echo "ðŸ“Š Version breakdown:"
        echo "   Major: ${{ steps.semver.outputs.major }}"
        echo "   Minor: ${{ steps.semver.outputs.minor }}"
        echo "   Patch: ${{ steps.semver.outputs.patch }}"
        if [ -n "${{ steps.semver.outputs.prerelease }}" ]; then
          echo "   Pre-release: ${{ steps.semver.outputs.prerelease }}"
        fi
        if [ -n "${{ steps.semver.outputs.build }}" ]; then
          echo "   Build: ${{ steps.semver.outputs.build }}"
        fi
        
        # Additional validation for common issues
        if [[ "${{ steps.semver.outputs.major }}" == "0" && "${{ steps.semver.outputs.minor }}" == "0" ]]; then
          echo "âš ï¸  Warning: Version ${{ steps.semver.outputs.version }} starts with 0.0. This is typically used for initial development."
        fi
        
        if [ -n "${{ steps.semver.outputs.prerelease }}" ]; then
          echo "â„¹ï¸  Pre-release version detected: ${{ steps.semver.outputs.version }}"
        fi

    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:v0.12.0

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}



    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.0

    - name: Cache Helm charts
      uses: actions/cache@v4
      with:
        path: ~/.cache/helm
        key: ${{ runner.os }}-helm-${{ hashFiles('helm/Chart.yaml') }}
        restore-keys: |
          ${{ runner.os }}-helm-

    - name: Generate CRDs
      run: |
        # Generate CRDs
        make generate manifests
        
        # Create combined CRD file
        mkdir -p dist
        cat config/crd/bases/*.yaml > dist/crds.yaml
      env:
        GOOS: linux
        GOARCH: amd64

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v6
      with:
        distribution: goreleaser
        version: '~> v2'
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        DOCKER_BUILDKIT: 1

    
  update-manifests:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, 'rc') && !contains(github.ref, 'beta') && !contains(github.ref, 'alpha') }}
    permissions:
      contents: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Update manifests
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Updating manifests for version: $VERSION"
        
        # Update the default kustomization to use the new image
        cd config/manager
        kustomize edit set image controller=ghcr.io/${{ github.repository_owner }}/litellm-operator:${{ github.ref_name }}
        cd ../..
        
        # Update Helm chart version and appVersion
        sed -i "s/^version: .*/version: $VERSION/" helm/Chart.yaml
        sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" helm/Chart.yaml
        
        # Update default image tag in values.yaml
        sed -i "s/^    tag: .*/    tag: \"$VERSION\"/" helm/values.yaml
        
        # Show the changes for debugging
        echo "Changes made:"
        git diff --stat
      env:
        GITHUB_REF: ${{ github.ref }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: update-manifests-${{ github.ref_name }}
        title: "chore: update operator image and helm chart to ${{ github.ref_name }}"
        body: |
          This PR updates the operator manifests and Helm chart to version ${{ github.ref_name }}.
          
          Changes made:
          - Updated operator image tag in kustomization
          - Updated Helm chart version and appVersion
          - Updated default image tag in values.yaml
          
          This PR was automatically created by the release workflow.
          
          **Note:** The Helm Chart Validation workflow will automatically run on this PR to ensure the chart is properly configured before merging.
        base: main
        delete-branch: true
        commit-message: "chore: update operator image and helm chart to ${{ github.ref_name }}"
        committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
        author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
        # labels: |
        #   automated
        #   release
        assignees: ${{ github.actor }}
 