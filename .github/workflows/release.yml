name: Release and Publish
run-name: Release and Publish ${{ github.ref_name }}
on:
  push:
    # tags:
    #   - "v*"
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "README.md"
      - "CHANGELOG.md"
      - "CONTRIBUTING.md"
      - "SECURITY.md"
      - "LICENSE"
      - "deploy/charts/litellm-operator/**"
      - "helm/**"

permissions:
  contents: write
  packages: write
  id-token: write
  pull-requests: write

env:
  GO_VERSION: '1.25'

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run tests
      run: make test

    - name: Run linting
      uses: golangci/golangci-lint-action@v9.2.0
      with:
        version: latest

  build-and-release:
    needs: run-tests
    runs-on: ubuntu-latest
    outputs:
      is_prerelease: ${{ steps.release_type.outputs.is_prerelease }}
      release_type: ${{ steps.release_type.outputs.release_type }}
      validated_version: ${{ steps.semver.outputs.version }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Validate semver tag
      id: semver
      uses: matt-usurp/validate-semver@v2
      with:
        version: ${{ github.ref }}

    - name: Determine release type and configuration
      id: release_type
      run: |
        echo "âœ… Valid semver tag: ${{ steps.semver.outputs.version }}"
        echo "ðŸ“Š Version breakdown:"
        echo "   Major: ${{ steps.semver.outputs.major }}"
        echo "   Minor: ${{ steps.semver.outputs.minor }}"
        echo "   Patch: ${{ steps.semver.outputs.patch }}"
        
        # Determine release type and GoReleaser config
        if [ -n "${{ steps.semver.outputs.prerelease }}" ]; then
          PRERELEASE="${{ steps.semver.outputs.prerelease }}"
          echo "   Pre-release: $PRERELEASE"
          echo "â„¹ï¸  Pre-release version detected: ${{ steps.semver.outputs.version }}"
          
          if [[ "$PRERELEASE" =~ ^(alpha|beta|rc) ]]; then
            echo "config_file=.goreleaser.prerelease.yml" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=prerelease" >> $GITHUB_OUTPUT
          else
            echo "config_file=.goreleaser.yml" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=other_prerelease" >> $GITHUB_OUTPUT
          fi
        else
          echo "config_file=.goreleaser.yml" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "release_type=stable" >> $GITHUB_OUTPUT
          echo "âœ… Stable release version: ${{ steps.semver.outputs.version }}"
        fi
        
        # Additional validation for common issues
        if [[ "${{ steps.semver.outputs.major }}" == "0" && "${{ steps.semver.outputs.minor }}" == "0" ]]; then
          echo "âš ï¸  Warning: Version ${{ steps.semver.outputs.version }} starts with 0.0. This is typically used for initial development."
        fi
        
        if [ -n "${{ steps.semver.outputs.build }}" ]; then
          echo "   Build: ${{ steps.semver.outputs.build }}"
        fi

    - uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:v0.12.0

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.0

    - name: Generate CRDs
      run: |
        # Generate CRDs
        make generate manifests
        
        # Create combined CRD file
        mkdir -p dist
        cat config/crd/bases/*.yaml > dist/crds.yaml
      env:
        GOOS: linux
        GOARCH: amd64

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v6
      with:
        distribution: goreleaser
        version: '~> v2'
        args: release --clean --config ${{ steps.release_type.outputs.config_file }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        DOCKER_BUILDKIT: 1

  update-manifests:
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write 
      checks: write
      statuses: write
      id-token: write
    steps:
    - name: Authenticate GitHub App
      id: github-app
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ secrets.LITELLM_OPERATOR_BOT_APP_ID }}
        private-key: ${{ secrets.LITELLM_OPERATOR_BOT_PRIVATE_KEY }}
    
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.12.0
 
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
  
    - uses: actions/checkout@v6
      with:
        ref: main
        token: ${{ steps.github-app.outputs.token }}

    - name: Install yq
      uses: mikefarah/yq@v4

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Update manifests
      run: |
        # Use validated semver version from previous step
        VERSION=${{ needs.build-and-release.outputs.validated_version }}
        echo "Updating manifests for version: $VERSION"
        
        # Update the default kustomization to use the new image
        cd config/manager
        kustomize edit set image controller=ghcr.io/${{ github.repository_owner }}/litellm-operator:$VERSION
        cd ../..

    - name: Update Helm chart
      run: |
        # Update Helm chart version and appVersion
        VERSION=${{ needs.build-and-release.outputs.validated_version }}
        yq -i ".version = \"$VERSION\"" deploy/charts/litellm-operator/Chart.yaml
        yq -i ".appVersion = \"$VERSION\"" deploy/charts/litellm-operator/Chart.yaml
        yq -i ".controllerManager.manager.image.tag = \"$VERSION\"" deploy/charts/litellm-operator/values.yaml

        # Show the changes for debugging
        echo "Changes made:"
        git diff --stat

    - name: Commit and push changes
      id: commit-and-push
      uses: EndBug/add-and-commit@v9
      with:
        message: "Automated update to ${{ needs.build-and-release.outputs.validated_version }} [skip ci]"
        default_author: github_actions
        push: true

    - name: Extract version from Chart.yaml
      id: version
      if: steps.commit-and-push.outputs.pushed == 'true'
      run: |
        VERSION=$(grep '^version:' deploy/charts/litellm-operator/Chart.yaml | awk '{print $2}')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing chart version $VERSION to GitHub Packages"

    - name: Chart | Push
      uses: appany/helm-oci-chart-releaser@v0.5.0
      if: steps.commit-and-push.outputs.pushed == 'true'
      with:
        name: litellm-operator
        repository: bbdsoftware/charts/
        tag: ${{ steps.version.outputs.version }}
        path: deploy/charts/litellm-operator
        registry: ghcr.io
        registry_username: ${{ github.actor }}
        registry_password: ${{ secrets.GITHUB_TOKEN }}
        update_dependencies: 'false'
