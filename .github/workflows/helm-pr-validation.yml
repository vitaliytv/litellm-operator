name: Validate Helm Chart PR

on:
  pull_request:
    branches: [ main ]
    paths:
      - "helm/**"
      - "config/crd/**"
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read

jobs:
  validate-helm-changes:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.12.0

    - name: Lint Helm chart
      run: |
        helm lint helm/
        helm template litellm-operator helm/ > /dev/null

    - name: Validate Helm chart
      run: |
        # Render templates to validate they work correctly
        helm template litellm-operator helm/ --dry-run
        # Test with different values to ensure templates are robust
        helm template litellm-operator helm/ --dry-run --set replicaCount=3
        helm template litellm-operator helm/ --dry-run --set image.tag=latest

    - name: Check for version consistency
      run: |
        # Extract version from Chart.yaml
        CHART_VERSION=$(grep '^version:' helm/Chart.yaml | awk '{print $2}')
        APP_VERSION=$(grep '^appVersion:' helm/Chart.yaml | awk '{print $2}' | tr -d '"')
        
        echo "Chart version: $CHART_VERSION"
        echo "App version: $APP_VERSION"
        
        # Check if this looks like a release PR
        if [[ "$PR_TITLE" == *"update operator image and helm chart"* ]]; then
          echo "This appears to be a release update PR"
          
          # Extract version from PR title
          PR_VERSION=$(echo "$PR_TITLE" | grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          if [ -n "$PR_VERSION" ]; then
            EXPECTED_VERSION=${PR_VERSION#v}
            echo "Expected version from PR title: $EXPECTED_VERSION"
            
            if [ "$CHART_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "❌ Chart version ($CHART_VERSION) doesn't match expected version ($EXPECTED_VERSION)"
              exit 1
            fi
            
            if [ "$APP_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "❌ App version ($APP_VERSION) doesn't match expected version ($EXPECTED_VERSION)"
              exit 1
            fi
            
            echo "✅ Version consistency check passed"
          fi
        fi
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}

    - name: Validate CRD changes
      run: |
        # Check if CRDs are up to date
        if [ -d "config/crd/bases" ]; then
          echo "Checking CRD files..."
          for crd in config/crd/bases/*.yaml; do
            if [ -f "$crd" ]; then
              echo "Validating CRD: $(basename $crd)"
              # Basic YAML validation
              python3 -c "import yaml; yaml.safe_load(open('$crd'))"
            fi
          done
        fi

    - name: Comment on PR
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Helm Chart Validation')
          );
          
          const status = '${{ job.status }}';
          const conclusion = status === 'success' ? '✅' : '❌';
          
          const commentBody = `## Helm Chart Validation ${conclusion}
          
          **Status:** ${status}
          
          **Validations performed:**
          - ✅ Helm chart linting
          - ✅ Template rendering
          - ✅ Version consistency check
          - ✅ CRD validation
          
          ${status === 'success' ? 'All validations passed! The Helm chart is ready for release.' : 'Some validations failed. Please check the logs above.'}
          
          ---
          *This comment was automatically generated by the Helm validation workflow.*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          } 